#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
set -euo pipefail
source "$(dirname "${BASH_SOURCE[0]}")/../lib/utils.bash"
check_dependencies

[[ -z "${ASDF_INSTALL_VERSION:-}" ]] && fail "ASDF_INSTALL_VERSION required"
[[ -z "${ASDF_INSTALL_PATH:-}" ]] && fail "ASDF_INSTALL_PATH required"

dp="${ASDF_DOWNLOAD_PATH:-${ASDF_INSTALL_PATH}/tmp}"

if [[ ! -d "${dp}" ]] || [[ ! -f "${dp}/nickel" ]]; then
  mkdir -p "${dp}"
  log_info "Downloading nickel ${ASDF_INSTALL_VERSION}..."
  download_file "$(get_download_url "${ASDF_INSTALL_VERSION}")" "${dp}/nickel"
  download_file "$(get_nls_download_url "${ASDF_INSTALL_VERSION}")" "${dp}/nls"
  chmod +x "${dp}/nickel" "${dp}/nls"
fi

mkdir -p "${ASDF_INSTALL_PATH}/bin"
cp "${dp}/nickel" "${ASDF_INSTALL_PATH}/bin/"
cp "${dp}/nls" "${ASDF_INSTALL_PATH}/bin/"
chmod +x "${ASDF_INSTALL_PATH}/bin/nickel" "${ASDF_INSTALL_PATH}/bin/nls"

[[ -d "${ASDF_INSTALL_PATH}/tmp" ]] && rm -rf "${ASDF_INSTALL_PATH}/tmp"

log_info "nickel ${ASDF_INSTALL_VERSION} installed (includes nls language server)"
